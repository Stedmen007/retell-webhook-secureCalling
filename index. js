const express = require('express');
const app = express();
app.use(express.json());

// Store allowed numbers in environment variables for easy updates
const ALLOWED_NUMBERS = process.env.ALLOWED_PHONE_NUMBERS.split(',');
const DEFAULT_AGENT_ID = process.env.DEFAULT_AGENT_ID;

app.post('/api/filter-call', async (req, res) => {
  const { event, call_inbound } = req.body;
  
  // Only handle inbound calls
  if (event !== 'call_inbound') {
    return res.status(400).json({ error: 'Invalid event type' });
  }

  // Get caller's number
  const callerNumber = call_inbound.from_number;

  // Check if caller is allowed
  const isAllowed = ALLOWED_NUMBERS.includes(callerNumber);

  // Return response based on filter result
  if (isAllowed) {
    res.json({
      call_inbound: {
        override_agent_id: DEFAULT_AGENT_ID,
      }
    });
  } else {
    // Empty response rejects the call
    res.json({});
  }
});

module.exports = app;
